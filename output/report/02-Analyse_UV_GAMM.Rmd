---
title: "02-Analyse_UV_GAMM"
author: "Meridith L. Bartley, PhD"
date: "`r Sys.Date()`"
header-includes:
  - \usepackage{booktabs}
  - \usepackage{caption}
  - \usepackage{longtable}
  - \usepackage{tabu}
  - \usepackage{floatrow}
  - \usepackage{subfig}
  - \usepackage{lineno}
  - \floatsetup[table]{capposition=top}
  - \usepackage{pdflscape}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
output:
  bookdown::pdf_document2: default  # fig_caption: yes
  bookdown::html_document2: default
---

```{r, echo=FALSE}
library(dplyr)
library(here)
library(lubridate)
library(ggplot2)
library(magrittr)
library(mgcv)

source(here("scripts/01-LoadData.R"))

#helps to format this document 
#by default the included code chunks do not appear in the report view
knitr::opts_chunk$set(echo = F, 
                      eval = F,
                      message = F, 
                      cache=TRUE, 
                      warning=FALSE, 
                      error=FALSE, 
                      root.dir = normalizePath(".."))

```

# Overview of Generalized Additive (Mixture) Models

## Why not a Time Series Approach?

## Assumptions Made

## Limitations

# Application to Middle Cottonwood Trail

## Poisson Log Link

## Seasonality Trends in Trail Use

## Linear Trends















```{r}

singleTrail <- trail_count %>%
  dplyr::filter(counterid == 31)

singleStrava <- strava_day %>%
  dplyr::filter(trailnumber == 586) %>% 
  # we want a single representation count value for multiple edges per day
  dplyr::group_by(timeframe) %>% 
  dplyr::mutate(max.count = max(totaltrips)) %>% 
  dplyr::select(-c(totaltrips, totalpeople, edge_uid)) %>% 
  dplyr::distinct()
# trail characteristics not pertinent for single trail analysis
# no variation within trail information

## Combine Camera Counts, Strava Counts, Weather, Trail Characteristics

singleTrail_CountsCovariates <- singleTrail %>%
  dplyr::left_join(
    singleStrava,
    by = c(
      "date" = "timeframe",
      "trailnumber" = "trailnumber",
      "trailname" = "trailname",
      "wday" = "wday"
    )
  ) %>%
  dplyr::left_join(weather, by = c("date" = "date"))

## Add in a Time variable
singleTrail_CountsCovariates$yday <- lubridate::yday(singleTrail_CountsCovariates$date)
```


```{r}
knitr::include_graphics(path = here("output/figures/MiddleCottonwood_TS.pdf"))
```


```{r}

gamm_uncorr <- gamm(count ~ s(yday) + 
                      s(as.integer(week), bs = 'cc', k = 8) +
                      s(as.integer(wday), bs = "cc", k = 7) +
                      s(daily_aqi_value) + 
                      max.count
                    ,
                data = singleTrail_CountsCovariates, 
                family = poisson)

summary(gamm_uncorr$gam)

layout(matrix(1:4, ncol = 2))
plot(gamm_uncorr$gam, scale = 0)
layout(1)

layout(matrix(1:2, ncol = 2))
acf(resid(gamm_uncorr$lme), lag.max = 36, main = "ACF")
pacf(resid(gamm_uncorr$lme), lag.max = 36, main = "pACF")
layout(1)
```

```{r}

 ctrl <- list(niterEM = 0, 
              msVerbose = TRUE, 
              optimMethod="L-BFGS-B")
 
 ## AR(1)
 m.AR1 <- gamm(count ~ 
              # s(yday) +
              s(as.integer(week), bs = 'cc', k = 8) +
              s(as.integer(wday), bs = "cc", k = 7) +
              s(daily_aqi_value) + 
              max.count,
            data = singleTrail_CountsCovariates, 
            family = poisson,
            # correlation = corARMA(p = 1, q = 0),
            correlation = corAR1(form = ~ yday),
            control = ctrl)
 
save(m.AR1, file=here("output/models/mAR1.rda"), compress='xz')

 
 ## AR(1)
 m1 <- mgcv::gamm(count ~
              # s(yday) + 
              s(as.integer(week), bs = 'cc', k = 8) +
              s(as.integer(wday), bs = "cc", k = 7) +
              s(daily_aqi_value) + 
              max.count,
            data = singleTrail_CountsCovariates, 
            family = poisson,
            correlation = corARMA(form = ~ 1|yday, p = 1, q = 0),
            # correlation = corAR1(),
            control = ctrl)
 
 ## AR(2)
 m2 <- gamm(count ~
              # s(yday) + 
              s(as.integer(week), bs = 'cc', k = 8) +
              s(as.integer(wday), bs = "cc", k = 7) +
              s(daily_aqi_value) + 
              max.count,
            data = singleTrail_CountsCovariates, 
            family = poisson,
            correlation = corARMA(form = ~ 1|yday, p = 2),
            # correlation = corAR1(),
            control = ctrl)
 
## AR(3)
m3 <- gamm(count ~ 
             # s(yday) + 
             s(as.integer(week), bs = 'cc', k = 8) +
             s(as.integer(wday), bs = "cc", k = 7) +
             s(daily_aqi_value) + 
             max.count,
           data = singleTrail_CountsCovariates, 
           family = poisson,
           correlation = corARMA(form = ~ 1|yday, p = 3, q = 0),
           control = ctrl)
```

