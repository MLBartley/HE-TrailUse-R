---
output:
  pdf_document: default
  html_document: default
---
#  Data Overview
```{r, echo=FALSE, message = F, warning = F, include = F}

library(ggplot2) #plots
library(here) #relative file paths
library(knitr) #nicer formated tables in report (pdf)
library(kableExtra) #more table formatting options
library(raster) #plotting counter location maps
library(magrittr)

# load packages

#helps to format this document 
#by default the included code chunks do not appear in the report view
knitr::opts_chunk$set(echo = F, 
                      eval = F,
                      message = F, 
                      cache=TRUE, 
                      warning=FALSE, 
                      error=FALSE, 
                      root.dir = normalizePath(".."))

`%notin%` <- Negate(`%in%`) #useful for exploring data

source(here::here("scripts/01-LoadData.R")) #loads + cleans data


```
<!-- \linenumbers -->
```{r, eval = T, include = F}
## number of trails (by trailname) for each source of data
length(unique(trail_count$trailname))
length(unique(strava_day$trailname))
length(unique(trail_char$trailname))
length(unique(c(strava_day$trailname, 
                trail_count$trailname, 
                trail_char$trailname)))

# which trails have counter deployed?
#note that some trails have multiple counter locations as indicated by 
#subseciton name (e.g. Bridger Ridge has M to Baldy AND steep way)
unique(trail_count$trailname)
unique(trail_count$countername)

##how many trails (by trailname) in Stava data but not Counter data?
table(unique(strava_day$trailname) %notin% unique(trail_count$trailname))

##hour many trails in Counter data not in Stava data?
table(unique(trail_count$trailname) %notin% unique(strava_day$trailname))

#which trails are only in Stava data?
unique(strava_day$trailname)[which(unique(strava_day$trailname) %notin% unique(trail_count$trailname))]

#which trails are only in Counter data?
unique(trail_count$trailname)[which(unique(trail_count$trailname) %notin% unique(strava_day$trailname))]

#all trail names combined 
unique(c(strava_day$trailname, trail_count$trailname, 
         trail_char$trailname))
```
For our analysis, we used trail use count data obtained from trail counters deployed along select multi-use recreational trails in the Bridger Mountains outside of Bozeman, Montana. These data will be used to create a predictive model for trail use over time for all trails in the Bridger Mountain range. 

## Sources of Data

We predict trail use from trail counters, weather, trail characteristics, and novel data sources provided by Headwaters Economics. The provided data sources are as follows:

1.  Headwaters Economics Counter Data
2.  Strava Data (aggregated)
3.  Weather covariates
4.  Trail characteristics

### Counter Data

Trail use camera counters were deployed at a subset (`r length(unique(trail_count$counterid))`) of all trails (`r length(unique(c(strava_day$trailname, trail_count$trailname, trail_char$trailname)))`) in the Bridger Mountains for [MIN DEPLOYMENT] to [MAX DEPLOYMENT] days. Metadata on trail camera hardware includes the counter owner. Metadata on trail camera location includes latitude and longitude. See Figure \@ref(fig:counter-locations)  for locations of trail counters in the Bridger Mountains.
```{r counter-locations, eval = T, fig.cap= "Locations Surveyed with infrared camera trail counters in Bridger Mountains"}

knitr::include_graphics(here("output/figures/camera_locations.pdf"))

```
From Headwaters Economics website:
> These data were collected using infrared counters rotated across 20 trails throughout the Bridgers.  The counters record a use each time the beam is broken and were installed to minimize inaccurate counts from dogs or vegetation. Because this method measures total traffic, on a trail where use predominately is out-and-back the number of users will be approixmately half of the total traffic. Counters were installed for anywhere from 13 to 61 days, with an average of 29 days at each site. To ensure sufficient data were collected, counters were installed longest on trails that were more remote or had relatively low use. 

```{r counter-byid-high, eval = T, fig.cap= "Timeseries plots of daily trail camera counts over time in the Bridger Mountains along high use trails."}

knitr::include_graphics(path = here("output/figures/Counter_byID_TS_highuse.pdf"))

```
```{r counter-byid-low, eval = T, fig.cap= "Timeseries plots of daily trail camera counts over time in the Bridger Mountains along low use trails."}

knitr::include_graphics(path = here("output/figures/Counter_byID_TS_lowuse.pdf"))

```
In Figures \@ref(fig:counter-byid-high) and \@ref(fig:counter-byid-low) we have time series plots for daily trail use counts separated by trail subsections (fill color indicates trail). Most trail subsections have a single camera deployed, however a subset (Baldy to Bridger, Ross Pass to Sacagawea Peak, Sacagawea Pass, and Corbly Gulch) have two cameras. For subsections with multiple cameras we have plotted the maximum count of trail uses between each camera per day. Several counters are placed along a single trails resulting in the capture of similar (i.e. non-independent) trail use information. For example, counter IDs 4, 5, 6, 7, and 9 are all located on Bridger Ridge and while the total counts for each counters are different (see Table \@ref(tab:counter-summary)) the time series plots show very similar patterns of use of time indicating non-independent counts. [Direct to Spatial Network section/recommendations]
```{r counter-summary, eval = T}
trail_table <- trail_count %>% 
  dplyr::group_by(counterid, trailname, 
                  subsectionname
                  ) %>% 
  dplyr::mutate( "start" = min(date),
                   "end" = max(date), 
                 "length.deployed" = (end-start+1)) %>%
  dplyr::summarise(count = sum(count),
                   start = format(min(start), "%m-%d"), #the min function here is just pulling off one of multiple values of the same date
                   end = format(min(end), "%m-%d"),
                   deployment = min(length.deployed)
                   # "avg.perday" = count/min(length.deployed)
                   ) %>% 
  dplyr::mutate("Mean Count per Day" = round(count/as.numeric(deployment),2))

kableExtra::landscape(knitr::kable(trail_table, 
                                   booktabs = T,
                                   format = 'latex',
                                   caption = "Total Number of Trail Camera Counts (2021)"))

```
In Table \@ref(tab:counter-summary) we provide a summary of trail use recorded for each counter deployed along trails in the Bridger Mountains. In addition to total counts for each counter, the deployment dates and duration of each trail counter camera (as determined by the first and last date of data provided) and average daily trail use over this deployment duration is reported. 
<!-- Notable: -->
<!--   * Two counters (ID #s 26 and 27) are located along the Corbly Gulch trail for nearly non-overlapping time periods.  -->
<!--   * Counter ID 25 seems to only have been deployed for a single day (South Fork Flathead Creek) -->
<!--   * Counter ID 24 was only deployed for 3 days (Shafthouse Hill - Upper Shafthouse).  -->
<!-- Outcome: -->
<!-- After discussion with Megan Lawson, -->
Due to low deployment times and possibly unreliable camera recordings, we have decided to remove the following trails (numbers refer to counter IDs) from this analysis:

  * #1 - Fairy Lakeshore
  * #16 - Felix Canyon
  * #24 - Shafthouse Hill (Upper Shafthouse)
  * #25 - South Fork Flathead Creek.
  
<!-- See Figure \@ref(fig:counter-locations) for locations of trail cameras.  -->
#### Hourly Data

For each trail counter camera deployed data is provided on a daily scale. Finer resolution data (i.e. hourly counts rather than daily) are available for 17 trails. 
<!-- Note that some of the trails have distinct subsection in 'trail_count' but not in 'trail_hourly'. I'm not sure that we'll need this information.  -->

The most likely use for these days is a quick look at how daily activity trends look (i.e. are there more hikers in mornings vs afternoon?). However since Strava data is not available on this resolutions it would not be easy to model this trend without a lot of data (i.e. counters deployed for longer amounts of time) to provide information on this trend in any model used. 

```{r hourly, eval= TRUE}
knitr::include_graphics(path = here("output/figures/hourly_bydayofweek.pdf"))
```

#### Strava Data

Strava count data are made available through Strava Metro. Data are binned (intervals of 5 with ceiling rounding) and aggregated on multiple scales (daily, monthly, annual). Counts are available as "total trips" and "total people". Total trips should always be larger than the total people count as people sometimes make multiple passes of a single trail (e.g. M laps). Strava trails are subdivided into "edges". Edge IDs (for the counter locations which often aligns with the trailhead edge) are available in the Counter data. Strava count data are available for the entire year of 2021 (not just summer monitoring as in the counter data). These data also include the overarching trail name and number (e.g. 511 - Bridger Foothills) that also correspond to the counter data provided by HE. 

It is important to note that when considering Strava data at the Trail scale (rather than edge scale) you are propagating rounding errors for each segment forward (+_ 1-4 for each edge?). Similarly, aggregating the data in the daily data frame to a monthly timescale will likely not match the information provided in the monthly data frame.  
<!-- ### Join IDs -->
```{r strava-summary, eval = T}
strava_table <- strava_year %>% 
  dplyr::group_by(trailname
                  ) %>% 
  dplyr::mutate( "start" = min(timeframe),
                   "end" = max(timeframe)) %>%
  dplyr::summarise(count = sum(totaltrips),
                   start = format(min(start), "%m-%d"), #the min function here is just pulling off one of multiple values of the same date
                   end = format(min(end), "%m-%d"), 
                   edges = dplyr::n())

knitr::kable(strava_table, 
              booktabs = T,
             format = 'latex',
             caption = "Total Number of Strava Counts (2021)")

```

```{r strava-bytrailname, eval = T}

knitr::include_graphics(path = here("output/figures/Strava_day_TS_bytrip.pdf"))
```

### Weather Covariates

The following weather covariates are available on a daily basis:

  1. Precipitation (in.)
  2. Temperature Max (degrees Fahrenheit)
  3. Temperature Min (degrees Fahrenheit)
  4. Mean Air Quality (AQI) 
  5. Mean PM_25 Concentration (micrograms per cubic meter)

These data do not vary spatially only temporally (i.e. the resolution is not fine enough to parse out different weather between trails on a given day).

Missing data (days):
 
 * Precipitation: `r length(which(is.na(weather$precipitation_in) ==T))`
 * Max Temp: `r length(which(is.na(weather$temp_max_f) ==T))`
 * Min Temp: `r length(which(is.na(weather$temp_min_f) ==T))`
 * AQI: `r length(which(is.na(weather$temp_min_f) ==T))`
 * Particulate Matter: `r length(which(is.na(weather$temp_min_f) ==T))`

```{r covariate plots, eval = T}

knitr::include_graphics(here::here("output/figures/weatherplots.pdf"))

```

### Trail Characteristics

The following characteristics are provided at the trail level. 

 * Latitude/Longitude (of trailhead?)
 * Time/Distance from Town 
 * Parking lot size (as three-level factor)
 * Description/Class (4-level factor of development)
 * Motorized vehicle use (3-level factor) 
 * Indicators for use of the following:
    + Dirt bikes
    + ATVS
    + Hiking
    + Pack/Saddle
    + Bicycle