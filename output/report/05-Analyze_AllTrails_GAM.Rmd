---
output:
  html_document: default
  pdf_document: default
---
# Analysis of All Camera-Monitered Bridger Trails: HGA(M)M Approach

```{r, echo=FALSE, message=F, warning=F, include = F}
library(dplyr)
library(here)
library(ggplot2)
library(gratia)
library(itsadug)
library(lubridate)
library(magrittr)
library(marginaleffects)
library(mgcv)
library(xtable)

source(here("scripts/01-LoadData.R"))

#helps to format this document 
#by default the included code chunks do not appear in the report view
knitr::opts_chunk$set(echo = F, 
                      eval = F,
                      message = F, 
                      cache=TRUE, 
                      warning=FALSE, 
                      error=FALSE, 
                      root.dir = normalizePath(".."))

options(knitr.table.format = function() {
  if (knitr::is_latex_output()) 'latex' else 'pandoc'
})


```

```{r, eval = T}
## Model Checking function
tsDiagGamm <- function(x, timevar, observed, f = 0.3, type = "normalized") {
  resi <- resid(x$lme, type = type)
  fits <- fitted(x$lme)
  on.exit(layout(1))
  layout(matrix(1:6, ncol = 3, byrow = TRUE))
  plot(resi ~ fits, ylab = "Normalized Residuals",
       xlab = "Fitted Values", main = "Fitted vs. Residuals")
  lines(lowess(x = fits, y = resi, f = f), col = "blue",
        lwd = 2)
  plot(resi ~ timevar, ylab = "Normalized Residuals",
       xlab = "Time", main = "Time series of residuals")
  lines(lowess(x = timevar, y = resi, f = f), col = "blue", lwd = 2)
  plot(observed ~ fits, ylab = "Observed",
       xlab = "Fitted Values", main = "Fitted vs. Observed",
       type = "n")
  abline(a = 0, b = 1, col = "red")
  points(observed ~ fits)
  lines(lowess(x = fits, y = observed, f = f), col = "blue",
        lwd = 2)
  hist(resi, freq = FALSE, xlab = "Normalized Residuals")
  qqnorm(resi)
  qqline(resi)
  acf(resi, main = "ACF of Residuals")
}
```

<!-- ## Application to All Camera-Monitered Bridger Trails -->

## Data Used 

```{r, eval = T}
allTrail$subsectionF<- factor(allTrail$subsectionname, order = F)
allTrail$trailnameF <- factor(allTrail$trailname, order = F)

sub.number <- length(unique(allTrail$subsectionname))

```

## Fitting a Generalized Additive Mixture Model

Here, we extend the Generalized Additive (Mixture) Model we examined in [SECTION] to include all Bridger trails with counter camera data. This extension now includes different grouping levels (trail subsections) that require modeling of nonlinear functional relationships between covariates and outcomes where the shape of the function itself varies between different grouping levels. Hierarchical GA(M)Ms provide a natural extension to the standard GAM framework that allows smooth functional relationships between predictor and response to vary between groups, but in such a way that the different functions are in some sense pooled toward a common shape.

In our application, where we want to estimate and predict trail use at trails in the Bridger Mountains, we may assume that each trail will have its own response function (e.g. melting snowpack may take longer at higher elevation and thus trail use would be concentrated on trails that clear sooner), but since the trails are all in the same range we can also expect similar responses over the year. Estimating a separate function for each trail (or subsection) throws away a lot of shared information and could result in highly noisy function estimates if there were only a few data points for some trails. Conversely, estimating a single average relationship could result in a function that does not predict any specific group well. 
We aimed for a hierarchical model that includes a global curve plus trail subsection-specific curves that were penalized to be close to the mean function.

### Accounting for Trail/Subsection Grouping

[OVERVIEW OF RANDOM EFFECTS IN GAMMS + DIFFICULTY OF DOING SO WITH TWO (UNBALANCED?) LEVELS/NESTING]

### Accounting for Temporal Dependence 

In several of the models outlined below we include a temporal autocorrelation structure for the errors. Autocorrelation is meant to capture either temporal or spatial dependence in a model. Sometimes this dependence can be capture using the fixed and random effects in a GAMM, however when modelling all trails in this dataset we observed remaining temporal dependence (not shown, but see the ACF and PACF graph explanations in SECTION for an overview of how to diagnose this dependence). With a GA(M)M approach we consider both autocorrelation and a moving average (MA) process. An autoregressive process (AR($n$)) is one in which the previous $n$ points influence the current observations. A moving average (MA) process is one in which the current value is an average of preceding white noise. We are most interested in the main (fixed) effects of our model, while any autocorrelation is ancillary, but necessary to include. 

### Global Smoothing Model (G)

We start with a simple GAMM structure with a single smooth for each of the variables. 

In R we can write our model as:

```{r, echo = T, eval = F}
gamm_modG_sub <- gamm(max.camera ~
                         s(yday, bs="tp", k = 30) +
                         s(subsectionF,
                           bs="re",k=25) +
                         s(month, 
                           bs="tp" k = 7) +
                         s(wday,
                           bs = "cc", k = 7) +
                         s(daily_aqi_value, 
                           bs="tp", k = 10) +
                         s(temp_max_f, 
                           bs="tp", k = 10) +
                         s(precipitation_in, 
                           bs="tp", k = 10) +
                         max.count
                        ,
                      method = 'REML',
                       data = allTrail, 
                      correlation = corARMA(form = ~yday|subsectionF,
                                            p = 7),
                      family = poisson, 
                      niterPQL = 20)
```

The arguments to the s() terms are smoothed. For each we explicitly specify the type of smoother to be used with the bs argument, and the maximum number of basis functions with k. The default type of smoother is the TPRS smoother  ("tp") and the default value for k (for TPRS) is 10. We use a cyclic cubic spline ("cc") for day of week (wday) and set k=7 as we have seven unique values in this variable. We also set k-7 for month for the same reason; the data spans seven months of the year. If camera counters are deployed year-round in the future we would use bs="cc" and k=12 for this variable. The random effect smoother (bs="re") that we used for the subsectionF factor always has a k value equal to the number of levels in the grouping variable (here, 25).

```{r subsection modG, eval = T, echo = F}
## Model G - Global smoother - A single common smoother for all observations
if(F){
  ## we are fitting several versions of Model G with increasing temporal structure on the errors. We will report the best one in this report, but provide the code for multiple specificiation in case a different model is needed in the future. 
  
  
  ## explore gam() approach - OK if other parameters take care of
  ## temporal dependence (don't seem to)
  
  gam_modG_sub <- gam(max.camera ~
                         s(yday, bs="tp") +
                        # trailnameF + 
                         s(subsectionF,
                           bs="re",
                           # by = trailnameF,
                           k=25) +
                         s(month, k = 7) +
                         s(wday,
                           bs = "cc", k = 7) +
                         s(daily_aqi_value) +
                         s(temp_max_f) +
                         s(precipitation_in) +
                         max.count
                        ,
                      method = 'REML',
                      # correlation = corARMA(form = ~yday|subsectionF, p = 5), 
                       data = allTrail, 
                       family = poisson, 
                      niterPQL = 20)
  
  ## gamm model - check if this takes care of temporal dependence as is (w/o temporal autocorr sturcture on errors)
 gamm_modG_sub <- gamm(max.camera ~
                         s(yday, bs="tp", k = 30) +
                        # trailnameF + 
                         s(subsectionF,
                           bs="re",
                           # by = trailnameF,
                           k=25) +
                         s(month, k = 7) +
                         s(wday,
                           bs = "cc", k = 7) +
                         s(daily_aqi_value) +
                         s(temp_max_f) +
                         s(precipitation_in) +
                         max.count
                        ,
                      method = 'REML',
                      # correlation = corARMA(form = ~yday|subsectionF, p = 5), 
                       data = allTrail, 
                       family = poisson, 
                      niterPQL = 20)
 
  gamm_modGAR1_sub <- gamm(max.camera ~
                         s(yday, bs="tp") +
                        # trailnameF + 
                         s(subsectionF,
                           bs="re",
                           # by = trailnameF,
                           k=25) +
                         s(month, k = 7) +
                         s(wday,
                           bs = "cc", k = 7) +
                         s(daily_aqi_value) +
                         s(temp_max_f) +
                         s(precipitation_in) +
                         max.count
                        ,
                      method = 'REML',
                      correlation = corAR1(form = ~yday|subsectionF),
                       data = allTrail, 
                       family = poisson, 
                      niterPQL = 20)
  
  gamm_modGARMA_sub <- gamm(max.camera ~
                         s(yday, bs="tp") +
                        # trailnameF + 
                         s(subsectionF,
                           bs="re",
                           # by = trailnameF,
                           k=25) +
                         s(month, k = 7) +
                         s(wday,
                           bs = "cc", k = 7) +
                         s(daily_aqi_value) +
                         s(temp_max_f) +
                         s(precipitation_in) +
                         max.count
                        ,
                      method = 'REML',
                      correlation = corARMA(form = ~yday|subsectionF,
                                            p = 7),
                       data = allTrail, 
                       family = poisson, 
                      niterPQL = 30)

save(gam_modG_sub, file=here("output/models/allT_subsection_gam_G.rda"),
     compress='xz')  

  save(gamm_modG_sub, file=here("output/models/allT_subsection_gamm_G.rda"),
     compress='xz') 
  
   save(gamm_modGAR1_sub, file=here("output/models/allT_subsection_gamm_G-AR1.rda"),
     compress='xz')
   
   save(gamm_modGARMA_sub, file=here("output/models/allT_subsection_gamm_G-ARMA.rda"),
     compress='xz')
}

load(here("output/models/allT_subsection_gam_G.rda"))
load(here("output/models/allT_subsection_gamm_G.rda"))
load(here("output/models/allT_subsection_gamm_G-AR1.rda"))
load(here("output/models/allT_subsection_gamm_G-ARMA.rda"))


```



```{r, eval = T, echo=T}
summary(gamm_modGARMA_sub$gam)
```

We plotted only QQ plots and fitted-vs. residual plots (FIGURE) to assess model G. Other common GAM diagnostic plots (e.g. fitted vs. response plots) are generally less useful for non-normally distributed data as it can be difficult to visually assess if the observed data shows more heteroskedasticity than expected.






```{r, eval = T, echo=T}
gratia::draw(gamm_modGARMA_sub$gam)
gratia::appraise(gamm_modGARMA_sub$gam)
gam.vcomp(gamm_modGARMA_sub$gam)

rg <- gratia::rootogram(gamm_modGARMA_sub$gam)
draw(rg)

allTrail_G <- allTrail %>% 
  tidyr::drop_na('daily_aqi_value')


with(allTrail_G, tsDiagGamm(gamm_modGARMA_sub, timevar = yday,
                          observed = max.camera))


layout(matrix(1:2, ncol = 2))
acf(resid(gamm_modGARMA_sub$lme, type = "normalized"), 
    lag.max = 36, main = "ACF")
pacf(resid(gamm_modGARMA_sub$lme, type = "normalized"),
     lag.max = 36, main = "pACF")
layout(1)
```



```{r, eval=T, result = "asis", message=F, include=knitr::is_latex_output(), echo= T, include = T}
gamtabs(gamm_modGARMA_sub$gam,
        caption="Summaty of Global Smoothing Model (G)",
        comment=FALSE, type='latex')

## the output of this is copy/pasted into next latex chunck
## unsure why doesn't appear as table properly

```

```{=latex}
\begin{table}[ht]
\centering
\begin{tabular}{lrrrr}
   \hline
A. parametric coefficients & Estimate & Std. Error & t-value & p-value \\ 
  (Intercept) & 2.4341 & 0.1264 & 19.2549 & $<$ 0.0001 \\ 
  max.count & 0.0130 & 0.0003 & 37.8803 & $<$ 0.0001 \\ 
   \hline
B. smooth terms & edf & Ref.df & F-value & p-value \\ 
  s(yday) & 7.8066 & 7.8066 & 2045.5808 & $<$ 0.0001 \\ 
  s(subsectionF) & 23.7638 & 24.0000 & 1935.4483 & $<$ 0.0001 \\ 
  s(wday) & 4.9576 & 5.0000 & 986.7435 & $<$ 0.0001 \\ 
  s(daily\_aqi\_value) & 8.5560 & 8.5560 & 234.0028 & $<$ 0.0001 \\ 
  s(temp\_max\_f) & 7.7900 & 7.7900 & 908.9799 & $<$ 0.0001 \\ 
   \hline
\end{tabular}
\caption{Summaty of Global Smoothing Model (G)} 
\label{tab.gam}
\end{table}
```

```{r, eval = T, echo = T}

#add the predicted values from the model 
allTrail_G <- transform(allTrail_G, 
                      mod_G = predict(gamm_modGARMA_sub$gam, 
                                      type = "response"))

ggplot(allTrail_G, aes(x=mod_G, y=max.camera)) +
  facet_wrap(~subsectionF) +
  geom_point(alpha=0.1) +
  geom_abline() +
  labs(x="Predicted count", y="Observed count")
```


```{r}

# setup prediction data
sub_modG_pred <- with(allTrail,
                      expand.grid(yday=round(seq(min(yday), max(yday), length=15), 0),
                                  # trailnameF=levels(trailnameF),
                                  subsectionF = levels(subsectionF), 
                                  # month = min(month):max(month), 
                                  # wday = min(wday):max(wday), 
                                  daily_aqi_value = seq(min(daily_aqi_value, na.rm = T),
                                                        max(daily_aqi_value, na.rm = T), 
                                                        length = 5),
                                  temp_max_f = seq(min(temp_max_f, na.rm = T), 
                                                   max(temp_max_f, na.rm = T), 
                                                   length = 5), 
                                    # precipitation_in = seq(min(precipitation_in, 
                                    #                            na.rm = T), 
                                    #                        max(precipitation_in, 
                                    #                            na.rm = T), 
                                    #                        length = 5),
                                    max.count = seq(min(max.count), 
                                                    max(max.count), 
                                                    length = 10)
                                  ))

## add back month, wday from yday and trailnameF from subsectionF
date <- lubridate::as_date(sub_modG_pred$yday, origin = as_date("2021-01-01"))
sub_modG_pred$wday <- lubridate::wday(date)

# make the prediction, add this and a column of standard errors to the prediction
# data.frame. 
sub_modG_pred <- cbind(sub_modG_pred,
                       predict(gamm_modG_sub$gam, 
                               sub_modG_pred, 
                               se.fit=TRUE, 
                               type="response"))
# make the plot. Note here the use of the exp() function to back-transform the
# predictions (which are for log-uptake) to the original scale
ggplot(data=allTrail, aes(x=yday, y=max.camera, group=subsectionF)) +
  facet_wrap(~subsectionF, nrow = 5) +
  geom_ribbon(aes(ymin=(fit - 2*se.fit), ymax=(fit + 2*se.fit), x=yday),
              data=sub_modG_pred, 
              alpha=0.3, 
              inherit.aes=FALSE) +
  geom_line(aes(y=(fit)), data=sub_modG_pred) +
  geom_point() #+
  # labs(x=expression(CO[2] ~ concentration ~ (mL ~ L^{-1})),
  #      y=expression(CO[2] ~ uptake ~ (mu*mol ~ m^{-2})))
```

### Single common smoother plus group-level smoothers that have the same wiggliness (model GS)

```{r subsection modGS, echo=T, eval=T}

if(F){
  gamm4_modGS_sub <- gamm4::gamm4(max.camera ~ 
                           s(yday, m=2, bs="tp", k = 10) +
                           s(yday, subsectionF,
                             m=2, bs="fs", k = 25) +
                           s(subsectionF, bs = "re") +
                           # trailnameF +
                           s(month, k = 7) +
                           s(wday, bs = "cc", k = 7) +
                           s(daily_aqi_value) +
                           s(temp_max_f) +
                           # s(precipitation_in) +
                           max.count
                         ,
                         data = allTrail, 
                         # method = "REML",
                         family = poisson#, 
                         # niterPQL = 20
                        )
  
  gamm_modGS_AR1_sub <- gamm(max.camera ~ 
                           s(yday, m=2, bs="tp", k = 10) +
                           s(yday, subsectionF,
                             m=2, bs="fs", k = 25) +
                           s(subsectionF, bs = "re") +
                           # trailnameF +
                           s(month, k = 7) +
                           s(wday,
                             bs = "cc", k = 7) +
                           s(daily_aqi_value) +
                           s(temp_max_f) +
                           # s(precipitation_in) +
                           max.count
                         ,
                         data = allTrail, 
                         method = "REML", 
                         correlation = corAR1(form = ~yday|subsectionF),
                         family = poisson#, 
                         # niterPQL = 20
                         )
  
  gamm_modGS_ARMA_sub <- gamm(max.camera ~ 
                           s(yday, m=2, bs="tp", k = 10) +
                           s(yday, subsectionF,
                             m=2, bs="fs", k = 25) +
                           s(subsectionF, bs = "re") +
                           # trailnameF +
                           s(month, k = 7) +
                           s(wday,
                             bs = "cc", k = 7) +
                           s(daily_aqi_value) +
                           s(temp_max_f) +
                           # s(precipitation_in) +
                           max.count
                         ,
                         data = allTrail, 
                         method = "REML", 
                         correlation = corARMA(form = ~yday|subsectionF, 
                                               p = 7),
                         family = poisson #, 
                         # niterPQL = 20
                         )

save(gamm4_modGS_sub, file=here("output/models/allT_subsection_gamm4_GS.rda"),
     compress='xz')

save(gamm_modGS_AR1_sub, file=here("output/models/allT_subsection_gamm_GS_AR1.rda"),
     compress='xz')

save(gamm_modGS_ARMA_sub, file=here("output/models/allT_subsection_gamm_GS_ARMA.rda"),
     compress='xz')
}

load(here("output/models/allT_subsection_gamm4_GS.rda"))
load(here("output/models/allT_subsection_gamm_GS_AR1.rda"))
load(here("output/models/allT_subsection_gamm_GS_ARMA.rda"))

```

```{r}

summary(gamm_modGS_sub$gam)
gratia::draw(gamm_modGS_sub$gam)
gratia::appraise(gamm_modGS_sub$gam)

with(allTrail_G, tsDiagGamm(gamm_modGS_sub, timevar = yday,
                          observed = max.camera))


layout(matrix(1:2, ncol = 2))
acf(residuals(gam_modGS_sub))
pacf(residuals(gam_modGS_sub))
layout(1)
```

```{r}
plot(allTrail$max.camera ~ allTrail$yday, 
     xlab = "Day of Year", ylab = "Trail Use Count", pch = as.numeric(allTrail$wday))

lines(fitted(gamm_modGS_AR1_sub$gam) ~ allTrail_G$yday, lty = "solid", col = "orange", lwd = 2)
```


### Single common smoother plus group-level smoothers with differing wiggliness (Model GI)

```{r subsection modGI}

if(F){
  gamm4_modGI_sub <- gamm4::gamm4(max.camera ~
                                  s(yday, m=2, bs="tp") +
                                  s(yday, by = subsectionF,
                                    m=1, bs="tp") +
                                  # s(subsectionF,
                                  #   bs="re", by = trailnameF, k=25) +
                                  # trailnameF +
                                  s(month, k = 7) +
                                  s(wday,
                                    bs = "cc", k = 7) +
                                  s(daily_aqi_value) +
                                  s(temp_max_f) +
                                  # s(precipitation_in) +
                                  max.count,
                                data = allTrail,
                                family = poisson)

# gamm4_modGI2_sub <- gamm4::gamm4(max.camera ~ 
#                                    s(yday, bs="tp") +
#                                    s(subsectionF, bs = "re")+
#                                    s(yday, by= subsectionF) +
#                                    s(wday,
#                                      bs = "cc", k = 7) +
#                                    s(daily_aqi_value) +
#                                    s(temp_max_f) +
#                                    s(precipitation_in) +
#                                    max.count
#                                  ,
#                                  data = allTrail, 
#                                  family = poisson#, 
#                                  # method = "REML"
# )

save(gamm4_modGI_sub, 
     file=here("output/models/allT_subsection_gamm4_GI.rda"),
     compress='xz')
}


summary(bam_modGI_sub)
itsadug::check_resid(bam_modGI_sub)

gratia::draw(bam_modGI_sub)
gratia::appraise(bam_modGI_sub)

layout(matrix(1:2, ncol = 2))
acf(resid(bam_modGI_sub), 
    lag.max = 36, main = "ACF")
pacf(resid(bam_modGI_sub),
     lag.max = 36, main = "pACF")
layout(1)


# gamm_modGI2_sub <- gamm(max.camera ~ 
#                          s(yday, m=2, bs="tp") + 
#                           s(subsectionF, bs = "re") +
#                          s(yday, by = subsectionF,
#                            m=1, bs="tp") +
#                          # s(subsectionF,
#                          #   bs="re", by = trailnameF, k=25) +
#                          trailnameF +
#                          s(month, k = 7) +
#                          s(wday,
#                            bs = "cc", k = 7) +
#                          s(daily_aqi_value) +
#                          s(temp_max_f) +
#                          s(precipitation_in) +
#                          max.count,
#                        data = allTrail, 
#                        family = poisson)
# 
# save(gamm_modGI_sub, file=here("output/models/allT_subsection_gamm_GI.rda"),
#      compress='xz')

## AR1 with rho - needs to define the multiple time series for each subsection
# allTrail2 <- itsadug::start_event(allTrail, 
#                                   column="yday",
#                                   event="subsectionF",
#                                   newcode = T)

allTrail <- allTrail %>% 
  dplyr::group_by(subsectionF) %>% 
  mutate(start.event = ifelse(min(yday) == yday, TRUE, FALSE)) %>% 
  dplyr::ungroup()

valRho <- acf(resid(bam_modGI_sub), plot=FALSE)$acf[2]


bam_modGI_AR1_sub <- bam(max.camera ~ 
                         s(yday, bs="tp") +
                         s(subsectionF, bs = "re")+
                         s(yday, by= subsectionF) +
                         s(wday,
                           bs = "cc", k = 7) +
                         s(daily_aqi_value) +
                         s(temp_max_f) +
                         s(precipitation_in) +
                         max.count,
                       data = allTrail, 
                       family = poisson,
                       AR.start=allTrail$start.event, 
                       rho=valRho)
save(bam_modGI_AR1_sub,
     here("output/models/allT_subsection_bam_GIAR1.rda"),
     compress='xz')

gratia::appraise(bam_modGI_AR1_sub)

layout(matrix(1:2, ncol = 2))
acf(resid(bam_modGI_AR1_sub), 
    lag.max = 36, main = "ACF")
pacf(resid(bam_modGI_AR1_sub),
     lag.max = 36, main = "pACF")
layout(1)
```


```{r}


gamm_modGS_AR1_sub <- gamm(max.camera ~ 
                         # s(yday, m=2, bs="tp") + 
                         s(yday, subsectionnumber,
                           m=2, bs="fs") +
                         s(month, k = 7) +
                         s(wday,
                           bs = "cc", k = 7) +
                         s(daily_aqi_value) +
                         s(temp_max_f) +
                         s(precipitation_in) +
                         max.count
                         , 
                       correlation = corAR1(form = ~ yday | subsectionnumber),
                       data = allTrail, 
                       family = poisson, niterPQL = 25)

save(gamm_modGS_AR1_sub, file=here("output/models/allT_subsection_gamm_GS_AR1.rda"),
     compress='xz')


summary(gamm_modGS_AR1_sub$gam)
gratia::draw(gamm_modGS_AR1_sub$gam)

layout(matrix(1:2, ncol = 2))
acf(resid(gamm_modGS_AR1_sub$lme, type = "normalized"), 
    lag.max = 36, main = "ACF")
pacf(resid(gamm_modGS_AR1_sub$lme, type = "normalized"),
     lag.max = 36, main = "pACF")
layout(1)



gamm_modGS_ARMA_sub <- gamm(max.camera ~ 
                         # s(yday, m=2, bs="tp") + 
                         s(yday, subsectionnumber,
                           m=2, bs="fs") +
                         s(month, k = 7) +
                         s(wday,
                           bs = "cc", k = 7) +
                         s(daily_aqi_value) +
                         s(temp_max_f) +
                         s(precipitation_in) +
                         max.count
                         , 
                       correlation = corARMA(form = ~ yday | subsectionnumber, 
                                             p = 3, q = 2),
                       data = allTrail, 
                       family = poisson)

save(gamm_modGS_ARMA_sub, file=here("output/models/allT_subsection_gamm_GS_ARMA.rda"),
     compress='xz')


summary(gamm_modGS_ARMA_sub$gam)
gratia::draw(gamm_modGS_ARMA_sub$gam)

layout(matrix(1:2, ncol = 2))
acf(resid(gamm_modGS_ARMA_sub$lme, type = "normalized"), 
    lag.max = 36, main = "ACF")
pacf(resid(gamm_modGS_ARMA_sub$lme, type = "normalized"),
     lag.max = 36, main = "pACF")
layout(1)





```


## Visual Inspection of Model

```{r}

# setup prediction data
CO2_modG_pred <- with(CO2,
                      expand.grid(conc=seq(min(conc), max(conc), length=100),
                                  Plant_uo=levels(Plant_uo)))
# make the prediction, add this and a column of standard errors to the prediction
# data.frame. Predictions are on the log scale.
CO2_modG_pred <- cbind(CO2_modG_pred,
                       predict(CO2_modG, 
                               CO2_modG_pred, 
                               se.fit=TRUE, 
                               type="response"))
# make the plot. Note here the use of the exp() function to back-transform the
# predictions (which are for log-uptake) to the original scale
ggplot(data=CO2, aes(x=conc, y=uptake, group=Plant_uo)) +
  facet_wrap(~Plant_uo) +
  geom_ribbon(aes(ymin=exp(fit - 2*se.fit), ymax=exp(fit + 2*se.fit), x=conc),
              data=CO2_modG_pred, 
              alpha=0.3, 
              inherit.aes=FALSE) +
  geom_line(aes(y=exp(fit)), data=CO2_modG_pred) +
  geom_point() +
  labs(x=expression(CO[2] ~ concentration ~ (mL ~ L^{-1})),
       y=expression(CO[2] ~ uptake ~ (mu*mol ~ m^{-2})))
```


```{r AIC_table, echo=FALSE,  fig.width=4, fig.height=6, message=FALSE, warning=FALSE, cache=TRUE}
AIC_table <- AIC(CO2_modG,CO2_modGS, CO2_modGI, CO2_modS, CO2_modI,
             bird_modG, bird_modGS, bird_modGI, bird_modS, bird_modI)%>%
  rownames_to_column(var= "Model")%>%
  mutate(data_source = rep(c("CO2","bird_data"), each =5))%>%
  group_by(data_source)%>%
  mutate(deltaAIC = AIC - min(AIC))%>%
  ungroup()%>%
  dplyr::select(-data_source)%>%
  mutate_at(.vars = vars(df,AIC, deltaAIC), 
            .funs = funs(round,.args = list(digits=0)))
```

```{r AIC_table_kable, echo=FALSE,  fig.width=4, fig.height=6, message=FALSE, warning=FALSE, cache=TRUE, purl=FALSE}
kable(AIC_table, format =table_out_format, 
      caption="AIC table comparing model fits for example datasets", 
      booktabs = TRUE)%>% 
  kable_styling(full_width = FALSE)%>%
  kableExtra::group_rows("A. CO2 models", 1,5)%>%
  kableExtra::group_rows("B. bird_move models", 6,10)
```

## Results

## Prediction/Forecasting

```{r}

```


## Limitations of Model


<!-- ```{r group by trailnumber, eval = F} -->

<!-- gamm_modGI <- gamm(max.camera ~ s(yday, m=2, bs="tp") +  -->
<!--                    s(yday, by = trailnumber, -->
<!--                       m=1, bs="tp") + -->
<!--                    s(trailnumber, bs="re", k=18) + -->
<!--                     s(month, k = 7) + -->
<!--                     s(wday, -->
<!--                       bs = "cc", k = 7) + -->
<!--                     s(daily_aqi_value) + -->
<!--                     s(temp_max_f) + -->
<!--                     s(precipitation_in) + -->
<!--                     max.count -->
<!--                  , -->
<!--                   data = allTrail,  -->
<!--                   family = poisson) -->

<!-- save(gamm_modGI, file=here("output/models/allT_gamm_GI.rda"), -->
<!--      compress='xz') -->


<!-- summary(gamm_modGI$gam) -->
<!-- gratia::draw(gamm_modGI$gam) -->

<!-- gamm_modGS <- gamm(max.camera ~ s(yday, m=2, bs="tp") +  -->
<!--                    s(yday, trailnumber, -->
<!--                       m=2, bs="fs") + -->
<!--                     s(month, k = 7) + -->
<!--                     s(wday, -->
<!--                       bs = "cc", k = 7) + -->
<!--                     s(daily_aqi_value) + -->
<!--                     s(temp_max_f) + -->
<!--                     s(precipitation_in) + -->
<!--                     max.count -->
<!--                  , -->
<!--                   data = allTrail,  -->
<!--                   family = poisson) -->

<!-- save(gamm_modGS, file=here("output/models/allT_gamm_GS.rda"), -->
<!--      compress='xz') -->


<!-- summary(gamm_modGS$gam) -->
<!-- gratia::draw(gamm_modGS$gam) -->

<!-- layout(matrix(1:2, ncol = 2)) -->
<!-- acf(resid(gamm_modGS$lme, type = "normalized"),  -->
<!--     lag.max = 36, main = "ACF") -->
<!-- pacf(resid(gamm_modGS$lme, type = "normalized"), -->
<!--      lag.max = 36, main = "pACF") -->
<!-- layout(1) -->

<!-- gamm_modGS_AR1 <- gamm(max.camera ~  -->
<!--                          # s(yday, m=2, bs="tp") +  -->
<!--                          s(yday, trailnumber, -->
<!--                            m=2, bs="fs") + -->
<!--                          s(month, k = 7) + -->
<!--                          s(wday, -->
<!--                            bs = "cc", k = 7) + -->
<!--                          s(daily_aqi_value) + -->
<!--                          s(temp_max_f) + -->
<!--                          s(precipitation_in) + -->
<!--                          max.count -->
<!--                          ,  -->
<!--                        correlation = corAR1(form = ~ yday | trailnumber), -->
<!--                        data = allTrail,  -->
<!--                        family = poisson) -->

<!-- save(gamm_modGS_AR1, file=here("output/models/allT_gamm_GS_AR1.rda"), -->
<!--      compress='xz') -->


<!-- summary(gamm_modGS_AR1$gam) -->
<!-- gratia::draw(gamm_modGS_AR1$gam) -->

<!-- layout(matrix(1:2, ncol = 2)) -->
<!-- acf(resid(gamm_modGS_AR1$lme, type = "normalized"),  -->
<!--     lag.max = 36, main = "ACF") -->
<!-- pacf(resid(gamm_modGS_AR1$lme, type = "normalized"), -->
<!--      lag.max = 36, main = "pACF") -->
<!-- layout(1) -->

<!-- ``` -->

